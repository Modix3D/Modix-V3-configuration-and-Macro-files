; Macro file for Duet WiFi
; Generated by Modix - Version 3.4.1 Macro D

var probing_tool = 0.000
; This allows you to compensate for whatever tool you use to measure the nozzle distance.
; It is set to 0.000 by default, you can set this to the thickness of the tool or paper you use for the Z-offset calibration
; A sheet of paper is on average 0.05 to 0.10mm thick.

var RunningTotal=0					; used for calculations later in the process
var Average=0						; used for calculations later in the process
var Lowest=0						; used for calculations later in the process
var Highest=0						; used for calculations later in the process

M300 S666 P666               		; beep
M291 S3 R"Setting the Z-offset Height" P"Press OK to continue, or CANCEL to abort"

if state.gpOut[0].pwm=0.03 			; check if probe is already deployed
	M280 P0 S80 					; retract BLTouch
	G4 S0.5							; wait 0.5s

if sensors.endstops[2].triggered 	; check if probe is already triggered
	M280 P0 S160 					; reset BL Touch
	G4 S0.5							; wait 0.5s

if sensors.probes[0].value[0]=1000 	; check if probe is in error state
	M280 P0 S160 I1 				; reset BL Touch
	G4 S0.5							; wait 0.5s
	M280 P0 S80 					; retract BLTouch
	G4 S0.5							; wait 0.5s

; If the printer hasn't been homed, home it
if !move.axes[0].homed || !move.axes[1].homed || !move.axes[2].homed
  G28								; home
else
	G1 Z{sensors.probes[0].diveHeight+1} F300 ; if axes are homed move to dive height +1mm

M561 								; clear any bed transform
M290 R0 S0							; cancel baby stepping
G90									; absolute movements

G1 X100 Y100 F1800					; move to X100, Y100
G4 P0								; wait for the movement to stop


if move.axes[2].machinePosition < sensors.probes[0].diveHeight
	G1 Z{sensors.probes[0].diveHeight+1} F300

M300 S1111 P666						; beep
M564 H0 S0							; ignore axis limits
M291 S2 R"Test Z Probe Trigger Height - Step 1" P"Place a paper sheet under the nozzle and raise the bed until slight friction can be noticed" Z1 ;

G92 Z0								; the nozzle should now be just touching the bed so set the logical Z position to match the physical Z position
M300 S666 P666						; beep

if move.axes[2].machinePosition < sensors.probes[0].diveHeight
	G1 Z{sensors.probes[0].diveHeight+1} F300
G1 X{move.axes[0].machinePosition - sensors.probes[0].offsets[0]} Y{move.axes[1].machinePosition - sensors.probes[0].offsets[1]} F1500

G4 P0								; wait for the movement to stop

M291 S2 R"Test Z Probe Trigger Height - Step 2" P"Please remove the paper sheet and wait for the bed-probing to begin" ;

while iterations < 10
	G1 Z{sensors.probes[0].diveHeight} F300	; move to dive height
		
	if state.gpOut[0].pwm=0.03
		echo "Probe ia already deployed - retracting"
		M280 P0 S80 				; retract BLTouch
		G4 S0.5						; wait 0.5s
	if sensors.endstops[2].triggered
		echo "Probe ia already triggered - resetting"
		M280 P0 S160				; reset BL Touch
		G4 S0.5						; wait 0.5s
	if sensors.probes[0].value[0]=1000 ; if probe is in error state
		echo "Probe in error state - resetting"
		M280 P0 S160 I1 			; reset BL Touch
		G4 S0.5						; wait 0.5s
		M280 P0 S80 				; retract BLTouch
		G4 S0.5						; wait 0.5s

	G30 S-1 						; do probe at current point
	;M118 P2 S{"Test # " ^ (iterations+1) ^ " Triggered @ " ^ move.axes[2].machinePosition ^ "mm"} ; send trigger height to Paneldue console
	;M118 P3 S{"Test # " ^ (iterations+1) ^ " Triggered @ " ^ move.axes[2].machinePosition ^ "mm"} ; send trigger height to DWC console

	if iterations == 0
		set var.Lowest={move.axes[2].machinePosition} ; set the new lowest reading to first probe height
		set var.Highest={move.axes[2].machinePosition} ; set the new highest reading to first probe height

	if move.axes[2].machinePosition < var.Lowest
		set var.Lowest={move.axes[2].machinePosition} ; set the new lowest reading
		;M118 P3 S{"new low reading = " ^ move.axes[2].machinePosition} ; send trigger height to DWC console
		G4 S0.3
	if move.axes[2].machinePosition > var.Highest
		set var.Highest={move.axes[2].machinePosition} ; set the new highest reading

		;M118 P3 S{"new high reading = " ^ move.axes[2].machinePosition} ; send trigger height to DWC console
		G4 S0.3
	set var.RunningTotal={var.RunningTotal + move.axes[2].machinePosition} ; set new running total
	;M118 P3 S{"running total = " ^ var.RunningTotal} ; send running total to DWC console
	G4 S0.5
set var.Average = {(var.RunningTotal - var.Highest - var.Lowest) / (10 - 2)} 	; calculate the average after discarding the high & low reading

;M118 P3 S{"running total = " ^ var.RunningTotal} ; send running total to DWC console
;M118 P3 S{"low reading = " ^ var.Lowest} ; send low reading to DWC console
;M118 P3 S{"high reading = " ^ var.Highest} ; send high reading to DWC console
M118 P2 S{"Average excluding high and low reading = " ^ var.Average} ; send average to PanelDue console
M118 P3 S{"Average excluding high and low reading = " ^ var.Average} ; send average to DWC console

;suggest new G31 values
;echo "suggested edit for G31 in config.g if not saved to config-overide.g"
;echo "change G31 Z parameter from Z" ^ sensors.probes[0].triggerHeight ^ " to Z" ^ var.Average

G31 P500 Z{var.Average} ; set Z probe offset to the average reading
M564 S1 H1 ; Reset limits
G1 Z{sensors.probes[0].diveHeight+1} F300 ; move head back to dive height

;M291 P{"Trigger height set to : " ^ sensors.probes[0].triggerHeight  ^ "mm. Press OK to save to config-overide.g, cancel to use until next restart"} R"Finished" S3


var Z_auto_offset = {var.Average+var.probing_tool} ; math to calculate the BLTouch offset
echo >"0:/sys/config_probe.g" "G31 Z"^{var.Z_auto_offset}				; write the Z-offset to the config_probe.g file

echo "the Z-offset has been stored in the config_probe.g file. The Z-offset is", var.Z_auto_offset, "mm"