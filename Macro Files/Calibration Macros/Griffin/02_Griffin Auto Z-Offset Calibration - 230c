; Macro file for Duet WiFi
; Generated by Modix - Version 3.4.2 Macro A

var errorfix = 0.000  		; constant offset
G31 Z0						; set Z-offset to Z=0
echo >"0:/sys/config_probe.g" "G31 Z0"

M291 S3 R"Heating up nozzle" P"Wait for the nozzle to reach printing temperatures"
M568 P0 S230				; set tool 0 (primary hotend) temperature to 230c
T0							; select tool 0 (primary hotend)
M116 P0 H5					; wait for temperature to reach within 5c of set temperature

M300 S666 P666 				; beep
M291 S3 R"Automatic Z Offset Calibration" P"Press OK to continue, or CANCEL to abort"

G28							; home all
G31 Z0						; set Z-offset to Z=0
M564 H1 S0             		; Negative movements are allowed
G29 S2						; cancel mesh bed compensation
G90 						; absolute positioning
G1 Z35						; raise Z to 35mm
M291 S3 R"Clean the nozzle" P"The nozzle has been pre-heated. Clean it from any plastic debris"
G1 X100 Y200 F6000			; go to X100, Y200
G4 P0						; wait for movements to have stopped


M300 S666 P666				; beep
M291 S3 P"Place the offset tool below the nozzle and press OK to perform the macro, or CANCEL to abort"

G4 P200 					; wait 200ms
G91							; relative moves
G1 H1 Z-19 F50				; move 19mm down, stop when hitting the offset tool (but don't risk crashing the bed)
G92 Z0 						; set current position as Z=0
G4 P200 					; wait 200ms
G1 Z11 F200					; move up 11mm

G91							; relative moves
G1 X{sensors.probes[0].offsets[0] * -1} Y{sensors.probes[0].offsets[1] * -1} F1500 ; move nozzle so that BLTouch is in it's position 
G90							; absolute moves

G30 S-3 					; probes Z and adjusts the probe trigger height to match the actual stop height.
G4 P200 					; wait 200ms
G91							; relative movement
M568 P0 S0					; set tool 0 temperatures to 0

var Z_auto_offset = {sensors.probes[0].triggerHeight+var.errorfix} ; math to calculate the BLTouch offset
echo >"0:/sys/config_probe.g" "G31 Z"^{var.Z_auto_offset}

echo "the Z-offset has been stored in the config_probe.g file. The Z-offset is", var.Z_auto_offset, "mm. Remove the offset tool and place it back in the box"
M291 S2 R"Z-offset has been stored" P"the Z-offset has been stored in the config_probe.g file. Verify the value stored with the value displayed in the console" 

M564 S1 H1      			; Negative movements are forbidden
M300 S666 P666 				; beep

T-1							; deselect all tools