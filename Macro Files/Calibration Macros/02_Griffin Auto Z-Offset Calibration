; Macro file for Duet WiFi
; Generated by Modix - Version 3.4.1 Macro A

set global.errorfix = 0.01  ; constant offset

M291 S3 R"Heating up nozzle" P"Wait for the nozzle to reach printing temperatures"
M568 P0 S215
T0
M116 P0 H5


M300 S666 P666 				; beep
M291 S3 R"Automatic Z Offset Calibration" P"Press OK to continue, or CANCEL to abort"
G28							; home all
M564 H1 S0             		; Negative movements are allowed
G29 S2						; cancel mesh bed compensation
G90 						; absolute positioning
G1 Z35						; raise Z to 35mm
G1 X100 Y100 F6000			; go to X100, Y100
M300 S666 P666				; beep
M291 S3 P"Place the offset tool below the nozzle and press OK to perform the macro, or CANCEL to abort"
G4 P200 					; wait 200ms
G91							; relative moves
G1 H1 Z-18 F100				; move 15mm down, stop when hitting the offset tool (but don't risk crashing the bed)
G92 Z0 						; set current position as Z=0
G4 P200 					; wait 200ms
G1 Z11						; move up 11mm
G1 X{global.probe_x_offs*-1} Y{global.probe_y_offs*-1} F4000	; move nozzle so that BLTouch is in it's position 
G90							; absolute movements
G30 S-3 					; probes Z and adjusts the probe trigger height to match the actual stop height.
G4 P200 					; wait 200ms
G91							; relative movement
var Z_auto_offset = {sensors.probes[0].triggerHeight-global.errorfix} ; math to calculate the BLTouch offset
echo >"0:/sys/config_probe.g" "G31 Z"^{var.Z_auto_offset}
M564 S1 H1      			; Negative movements are forbidden
M300 S666 P666 				; beep
M291 S3 R"Auto Z Offset Calibration is Done!" P"Remove the offset tool and place it back in the the box"
	
M568 P0 S0
T-1