; Macro file for Duet WiFi
; Generated by Modix - Version 3.4.2 Macro A

var probing_tool = 0.000
; This allows you to compensate for whatever tool you use to measure the nozzle distance.
; It is set to 0.000 by default, you can set this to the thickness of the tool or paper you use for the Z-offset calibration
; A sheet of paper is on average 0.05 to 0.10mm thick.

M300 S666 P666               ; beep
M291 S3 R"Setting the Z-offset Height" P"Press OK to continue, or CANCEL to abort"

M98 P"config_probe.g"												; Load BLTouch probe settings
M280 P0 S60 I1														; clear any probe errors
G29 S2                      										; cancel mesh bed compensation
G91                    												; relative positioning
M913 X50 															; X axis 50% power
G1 H2 Z5 F200          												; lift Z relative to current position
G1 H1 X{(move.axes[0].max+5)*-1} Y{move.axes[1].max+5} F3000  		; move quickly to X and Y axis endstops and stop there (first pass)
G1 H2 X5 Y-5 F600      												; go back a few mm
G1 H1 X{(move.axes[0].max+5)*-1} Y{move.axes[1].max+5} F600  		; move slowly to X and Y axis endstops once more (second pass)
M913 X100 															; X axis 100% power
G90                    												; absolute positioning
G1 X{move.axes[0].min+5} Y{move.axes[1].min+5} F6000 				; move to front left
G1 F600																; reduce speed
G30                    												; home Z by probing the bed

G29 S2						; cancel mesh bed compensation
M290 R0 S0					; cancel baby stepping
G90							; absolute movements

G1 Z10						; move the nozzle up
G1 X100 Y100 F1800			; move to X100, Y100
G4 P0						; wait for the movement to stop

M300 S1111 P666				; beep
M564 H1 S0					; ignore axis limits
M291 S2 R"Test Z Probe Trigger Height - Step 1" P"Place a paper sheet under the nozzle and raise the bed until slight friction can be noticed" Z1 ;

G92 Z0						; the nozzle should now be just touching the bed so set the logical Z position to match the physical Z position
M300 S666 P666				; beep
G1 Z8 F300					; insure Z position will allow for probing

G91							; relative moves
G1 X{sensors.probes[0].offsets[0] * -1} Y{sensors.probes[0].offsets[1] * -1} F1500 ; move nozzle so that BLTouch is in it's position 
G90							; absolute moves

G4 P0						; wait for the movement to stop

M291 S2 R"Test Z Probe Trigger Height - Step 2" P"Please remove the paper sheet and wait for the bed-probing to begin" ;
G30 S-1						; probe the bed and report the Z probe trigger height
M564 S1 H1					; respect axis limits

var Z_auto_offset = {sensors.probes[0].lastStopHeight+var.probing_tool} ; math to calculate the BLTouch offset
echo >"0:/sys/config_probe.g" "G31 Z"^{var.Z_auto_offset}				; write the Z-offset to the config_probe.g file

echo "the Z-offset has been stored in the config_probe.g file. The Z-offset is", var.Z_auto_offset, "mm"

G4 P0						; wait for the movement to stop
G91							; relative movements
G1 Z10 F300					; Lift up the nozzle again so it's not pressed against the bed surface
G90							; absolute movements
M18							; release stepper motors